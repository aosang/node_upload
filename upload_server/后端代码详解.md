# åç«¯å›¾ç‰‡ä¸Šä¼ å¤„ç†è¯¦è§£ï¼ˆåˆå­¦è€…ç‰ˆï¼‰

> ğŸ’¡ **é˜…è¯»æç¤º**ï¼šæœ¬æ–‡æ¡£æŒ‰ç…§ä»£ç æ‰§è¡Œé¡ºåºå’Œä¸šåŠ¡æµç¨‹è®²è§£ï¼Œé€šä¿—æ˜“æ‡‚ï¼Œé€‚åˆåˆå­¦è€…ç†è§£ã€‚

## ğŸ“š ç›®å½•
1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [åˆå§‹åŒ–é…ç½®](#åˆå§‹åŒ–é…ç½®)
3. [æ ¸å¿ƒæ¥å£è¯¦è§£](#æ ¸å¿ƒæ¥å£è¯¦è§£)
4. [å®Œæ•´æµç¨‹å›¾](#å®Œæ•´æµç¨‹å›¾)
5. [å‰åç«¯äº¤äº’](#å‰åç«¯äº¤äº’)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ•´ä½“æ¶æ„

è¿™æ˜¯ä¸€ä¸ªåŸºäº **Express + Multer** çš„æ–‡ä»¶ä¸Šä¼ æœåŠ¡å™¨ï¼Œå®ç°äº†ï¼š

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| ğŸ“¦ **åˆ†å—æ¥æ”¶** | æ¥æ”¶å‰ç«¯å‘æ¥çš„æ–‡ä»¶åˆ†å— |
| ğŸ”€ **åˆ†å—åˆå¹¶** | å°†æ‰€æœ‰åˆ†å—åˆå¹¶æˆå®Œæ•´æ–‡ä»¶ |
| ğŸ’¾ **æ–‡ä»¶å­˜å‚¨** | ä¿å­˜åˆ° uploads ç›®å½• |
| ğŸ—‘ï¸ **ä¸´æ—¶æ¸…ç†** | åˆå¹¶ååˆ é™¤ä¸´æ—¶åˆ†å— |
| ğŸ¯ **é‡å¤æ£€æµ‹** | é¿å…é‡å¤ä¸Šä¼ ç›¸åŒæ–‡ä»¶ |
| ğŸ”’ **å®Œæ•´æ€§éªŒè¯** | åŒé‡éªŒè¯ç¡®ä¿æ–‡ä»¶çœŸå®å­˜åœ¨ |

**é€šä¿—ç†è§£**ï¼š
```
åç«¯å°±åƒä¸€ä¸ª"å¿«é€’ä¸­å¿ƒ"ï¼š

1. æ¥æ”¶åŒ…è£¹ï¼ˆåˆ†å—ï¼‰
2. éªŒè¯åŒ…è£¹ï¼ˆæ£€æŸ¥ï¼‰
3. ç»„è£…å•†å“ï¼ˆåˆå¹¶ï¼‰
4. æ”¾å…¥ä»“åº“ï¼ˆå­˜å‚¨ï¼‰
5. æ¸…ç†çº¸ç®±ï¼ˆåˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼‰
```

---

## åˆå§‹åŒ–é…ç½®

### 1. å¯¼å…¥ä¾èµ–åŒ…

```javascript
import express from 'express'      // Web æ¡†æ¶
import cors from 'cors'            // è·¨åŸŸæ”¯æŒ
import path from 'path'            // è·¯å¾„å¤„ç†
import fs from 'fs-extra'          // æ–‡ä»¶ç³»ç»Ÿï¼ˆå¢å¼ºç‰ˆï¼‰
import multer from 'multer'        // æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶
import { fileURLToPath } from 'url'  // URL è½¬æ–‡ä»¶è·¯å¾„
import { dirname } from 'path'     // è·å–ç›®å½•å
```

**å„ä¸ªåŒ…çš„ä½œç”¨**ï¼š
```
expressï¼šæ­å»º Web æœåŠ¡å™¨
  - å¤„ç† HTTP è¯·æ±‚ï¼ˆGETã€POSTï¼‰
  - å®šä¹‰è·¯ç”±ï¼ˆ/upload-chunkã€/merge-chunksï¼‰
  
corsï¼šå¤„ç†è·¨åŸŸè¯·æ±‚
  - å‰ç«¯ï¼šlocalhost:5173
  - åç«¯ï¼šlocalhost:3000
  - ä¸åŒåŸŸåï¼Œéœ€è¦ cors æ”¯æŒ

multerï¼šå¤„ç†æ–‡ä»¶ä¸Šä¼ 
  - æ¥æ”¶ FormData ä¸­çš„æ–‡ä»¶
  - ä¿å­˜åˆ°ç£ç›˜

fs-extraï¼šæ–‡ä»¶æ“ä½œï¼ˆæ¯”åŸç”Ÿ fs æ›´å¼ºå¤§ï¼‰
  - fs.readFile() - è¯»å–æ–‡ä»¶
  - fs.writeFile() - å†™å…¥æ–‡ä»¶
  - fs.remove() - åˆ é™¤æ–‡ä»¶/ç›®å½•
  - fs.ensureDirSync() - ç¡®ä¿ç›®å½•å­˜åœ¨
```

---

### 2. ESæ¨¡å—è·¯å¾„å¤„ç†

```javascript
const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸¤è¡Œï¼Ÿ**
```
åœ¨ ESæ¨¡å— ä¸­ï¼Œæ²¡æœ‰ __dirname å’Œ __filename
éœ€è¦æ‰‹åŠ¨è·å–ï¼š

import.meta.urlï¼šå½“å‰æ–‡ä»¶çš„ URL
  "file:///F:/node_upload/upload_server/app.js"
  
fileURLToPath()ï¼šURL è½¬æ–‡ä»¶è·¯å¾„
  "F:/node_upload/upload_server/app.js"
  
dirname()ï¼šè·å–ç›®å½•
  "F:/node_upload/upload_server"
```

---

### 3. åˆ›å»º Express åº”ç”¨

```javascript
const app = express()  // åˆ›å»ºåº”ç”¨å®ä¾‹
app.use(cors())        // å¯ç”¨è·¨åŸŸ
```

**app.use() æ˜¯ä»€ä¹ˆï¼Ÿ**
```
app.use() ç”¨äºæ³¨å†Œä¸­é—´ä»¶ï¼š
- ä¸­é—´ä»¶å°±åƒ"æ£€æŸ¥ç«™"
- æ¯ä¸ªè¯·æ±‚éƒ½è¦ç»è¿‡è¿™äº›æ£€æŸ¥ç«™
- cors() å°±æ˜¯ä¸€ä¸ªæ£€æŸ¥ç«™ï¼Œå…è®¸è·¨åŸŸè¯·æ±‚

ç±»ä¼¼äºï¼š
æœºåœºå®‰æ£€ â†’ æ¯ä¸ªä¹˜å®¢éƒ½è¦ç»è¿‡
cors() â†’ æ¯ä¸ªè¯·æ±‚éƒ½è¦ç»è¿‡
```

---

### 4. é…ç½®ç›®å½•

```javascript
// æœ€ç»ˆæ–‡ä»¶ç›®å½•
const upload_dir = path.resolve(__dirname, 'uploads')
fs.ensureDirSync(upload_dir)

// ä¸´æ—¶åˆ†å—ç›®å½•
const temp_dir = path.resolve(__dirname, 'temp_chunks')
fs.ensureDirSync(temp_dir)

// ğŸ¯ å®Œæˆæ ‡è®°ç›®å½•ï¼ˆé˜²æ­¢é‡å¤ä¸Šä¼ ï¼‰
const completed_dir = path.resolve(__dirname, 'upload_completed')
fs.ensureDirSync(completed_dir)
console.log(`å®Œæˆæ ‡è®°ç›®å½•: ${completed_dir}`)
```

**path.resolve() æ˜¯ä»€ä¹ˆï¼Ÿ**
```javascript
__dirname = "F:/node_upload/upload_server"

path.resolve(__dirname, 'uploads')
// â†’ "F:/node_upload/upload_server/uploads"

path.resolve(__dirname, 'temp_chunks')
// â†’ "F:/node_upload/upload_server/temp_chunks"

path.resolve(__dirname, 'upload_completed')
// â†’ "F:/node_upload/upload_server/upload_completed"
```

**fs.ensureDirSync() æ˜¯ä»€ä¹ˆï¼Ÿ**
```
ç¡®ä¿ç›®å½•å­˜åœ¨ï¼š
- å¦‚æœç›®å½•ä¸å­˜åœ¨ â†’ åˆ›å»ºå®ƒ
- å¦‚æœç›®å½•å·²å­˜åœ¨ â†’ ä»€ä¹ˆéƒ½ä¸åš

ç±»ä¼¼äºï¼š
if (!ç›®å½•å­˜åœ¨) {
  åˆ›å»ºç›®å½•()
}
```

**ç›®å½•ç»“æ„**ï¼š
```
upload_server/
â”œâ”€â”€ uploads/              â† æœ€ç»ˆæ–‡ä»¶ä¿å­˜åœ¨è¿™é‡Œ
â”‚   â”œâ”€â”€ test1-xxx.jpg
â”‚   â””â”€â”€ test2-xxx.jpg
â”œâ”€â”€ temp_chunks/          â† ä¸´æ—¶åˆ†å—ä¿å­˜åœ¨è¿™é‡Œ
â”‚   â”œâ”€â”€ test1.jpg_512000_.../
â”‚   â”‚   â”œâ”€â”€ chunk-0
â”‚   â”‚   â”œâ”€â”€ chunk-1
â”‚   â”‚   â””â”€â”€ chunk-2
â”‚   â””â”€â”€ test2.jpg_819200_.../
â”‚       â””â”€â”€ chunk-0
â””â”€â”€ upload_completed/     â† ğŸ¯ å®Œæˆæ ‡è®°ä¿å­˜åœ¨è¿™é‡Œï¼ˆæ–°å¢ï¼‰
    â”œâ”€â”€ test1.jpg_512000_...  (å†…å®¹æ˜¯æœ€ç»ˆæ–‡ä»¶å)
    â””â”€â”€ test2.jpg_819200_...
```

**upload_completed çš„ä½œç”¨**ï¼š
```
é˜²æ­¢é‡å¤ä¸Šä¼ ï¼š
1. æ–‡ä»¶ä¸Šä¼ å®Œæˆå â†’ åˆ›å»ºæ ‡è®°æ–‡ä»¶
2. å†æ¬¡ä¸Šä¼ åŒä¸€æ–‡ä»¶ â†’ æ£€æŸ¥æ ‡è®° â†’ è·³è¿‡ä¸Šä¼ 
3. åŒæ—¶éªŒè¯å®é™…æ–‡ä»¶æ˜¯å¦å­˜åœ¨ â†’ ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

æ ‡è®°æ–‡ä»¶å†…å®¹ï¼š
æœ€ç»ˆæ–‡ä»¶åï¼ˆä¾‹å¦‚ï¼š"test-1704067200000.jpg"ï¼‰
```

---

### 5. é…ç½®é™æ€æ–‡ä»¶è®¿é—®

```javascript
app.use('/uploads', express.static(upload_dir))
```

**ä½œç”¨**ï¼š
```
è®¿é—®ï¼šhttp://localhost:3000/uploads/test1-xxx.jpg
å®é™…è®¿é—®ï¼šF:/node_upload/upload_server/uploads/test1-xxx.jpg

å°±åƒç»™æ–‡ä»¶å¤¹åˆ›å»ºä¸€ä¸ªç½‘å€å…¥å£
```

---

### 6. é…ç½® Multer

```javascript
const storage = multer.diskStorage({
  // ä¿å­˜ä½ç½®
  destination: function (req, file, cb) {
    cb(null, upload_dir)  // ä¿å­˜åˆ° uploads ç›®å½•
  },
  
  // æ–‡ä»¶å
  filename: function (req, file, cb) {
    const ext = path.extname(file.originalname)    // è·å–æ‰©å±•å
    const basename = path.basename(file.originalname, ext)  // è·å–æ–‡ä»¶å
    cb(null, `${basename}-${Date.now()}${ext}`)    // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
  }
})

const upload = multer({ storage: storage })
```

**Multer çš„ä½œç”¨**ï¼š
```
å¤„ç† FormData æ–‡ä»¶ä¸Šä¼ ï¼š
1. æ¥æ”¶å‰ç«¯å‘æ¥çš„æ–‡ä»¶
2. ä¿å­˜åˆ°ç£ç›˜
3. æä¾›æ–‡ä»¶ä¿¡æ¯ï¼ˆreq.fileï¼‰
```

**æ–‡ä»¶åç”Ÿæˆ**ï¼š
```javascript
originalname: "test.jpg"

ext = path.extname("test.jpg")  // ".jpg"
basename = path.basename("test.jpg", ".jpg")  // "test"

filename = `${basename}-${Date.now()}${ext}`
// â†’ "test-1704067200000.jpg"

// åŠ æ—¶é—´æˆ³é¿å…æ–‡ä»¶åå†²çª
```

**cb() æ˜¯ä»€ä¹ˆï¼Ÿ**
```javascript
// cb æ˜¯ callbackï¼ˆå›è°ƒå‡½æ•°ï¼‰çš„ç¼©å†™
cb(é”™è¯¯, ç»“æœ)

// æ²¡æœ‰é”™è¯¯ï¼Œè¿”å›ç»“æœ
cb(null, 'ç»“æœ')

// æœ‰é”™è¯¯
cb(new Error('å‡ºé”™äº†'))
```

---

### 7. ä¸­é—´ä»¶é…ç½®

```javascript
app.use(express.json())  // è§£æ JSON æ ¼å¼çš„è¯·æ±‚ä½“
```

**ä½œç”¨**ï¼š
```
å‰ç«¯å‘é€ï¼š
POST /merge-chunks
Content-Type: application/json
{ "filename": "test.jpg", "fileId": "..." }

åç«¯æ¥æ”¶ï¼š
req.body = { filename: "test.jpg", fileId: "..." }

express.json() è‡ªåŠ¨æŠŠ JSON å­—ç¬¦ä¸²è½¬æˆå¯¹è±¡
```

---

## æ ¸å¿ƒæ¥å£è¯¦è§£

### æ¥å£1: POST /upload-chunk - ä¸Šä¼ åˆ†å—

```javascript
app.post('/upload-chunk', upload.single('chunk'), (req, res) => {
```

**upload.single('chunk')** æ˜¯ä»€ä¹ˆï¼Ÿ
```
upload.single('å­—æ®µå')ï¼šå¤„ç†å•ä¸ªæ–‡ä»¶ä¸Šä¼ 
- å­—æ®µåå¿…é¡»å’Œå‰ç«¯ FormData ä¸­çš„åç§°ä¸€è‡´
- å‰ç«¯ï¼šformData.append('chunk', blob)
- åç«¯ï¼šupload.single('chunk')

å¤„ç†åï¼Œæ–‡ä»¶ä¿¡æ¯åœ¨ req.file ä¸­
```

#### æ­¥éª¤1ï¼šè·å–å‚æ•°

```javascript
  try {
    const { filename, fileId, chunkNumber, totalChunks } = req.body
    
    if (!req.file) {
      return res.status(400).json({
        success: false,
        message: 'æœªæ¥æ”¶åˆ°åˆ†å—æ–‡ä»¶'
      })
    }
```

**req.body å’Œ req.file çš„åŒºåˆ«**ï¼š
```
req.bodyï¼šæ–‡æœ¬æ•°æ®
  { filename: "test.jpg", fileId: "...", chunkNumber: 0 }
  
req.fileï¼šæ–‡ä»¶æ•°æ®
  {
    fieldname: 'chunk',
    originalname: 'blob',
    filename: 'test-1704067200000.jpg',
    path: 'F:/node_upload/upload_server/uploads/test-1704067200000.jpg',
    size: 1048576
  }
```

**res.status(400).json()** æ˜¯ä»€ä¹ˆï¼Ÿ
```javascript
// è®¾ç½® HTTP çŠ¶æ€ç å¹¶è¿”å› JSON
res.status(400).json({ success: false, message: 'é”™è¯¯ä¿¡æ¯' })

// 400 = Bad Requestï¼ˆè¯·æ±‚é”™è¯¯ï¼‰
// 200 = OKï¼ˆæˆåŠŸï¼‰
// 404 = Not Foundï¼ˆæœªæ‰¾åˆ°ï¼‰
// 500 = Internal Server Errorï¼ˆæœåŠ¡å™¨é”™è¯¯ï¼‰
```

#### æ­¥éª¤2ï¼šåˆ›å»ºåˆ†å—ç›®å½•

```javascript
    // ä½¿ç”¨ fileId åˆ›å»ºåˆ†å—ç›®å½•
    const chunkDir = path.resolve(temp_dir, fileId)
    fs.ensureDirSync(chunkDir)
```

**ç¤ºä¾‹**ï¼š
```javascript
fileId = "test.jpg_512000_1704067200000"
chunkDir = "F:/node_upload/upload_server/temp_chunks/test.jpg_512000_1704067200000"

fs.ensureDirSync(chunkDir)
// â†’ åˆ›å»ºç›®å½•ï¼štemp_chunks/test.jpg_512000_1704067200000/
```

**ä¸ºä»€ä¹ˆç”¨ fileId ä½œä¸ºç›®å½•åï¼Ÿ**
```
ä¸åŒçš„æ–‡ä»¶æœ‰ä¸åŒçš„ fileIdï¼š
test1.jpg â†’ temp_chunks/test1.jpg_512000_.../
test2.jpg â†’ temp_chunks/test2.jpg_819200_.../

æ¯ä¸ªæ–‡ä»¶çš„åˆ†å—ä¿å­˜åœ¨ç‹¬ç«‹ç›®å½•
ä¸ä¼šäº’ç›¸è¦†ç›–
```

#### æ­¥éª¤3ï¼šä¿å­˜åˆ†å—

```javascript
    // ä¿å­˜åˆ†å—æ–‡ä»¶
    const chunkPath = path.resolve(chunkDir, `chunk-${chunkNumber}`)
    fs.moveSync(req.file.path, chunkPath, { overwrite: true })
    
    console.log(`å·²æ¥æ”¶: ${filename} åˆ†å— ${chunkNumber}/${totalChunks}`)
```

**fs.moveSync() æ˜¯ä»€ä¹ˆï¼Ÿ**
```
ç§»åŠ¨æ–‡ä»¶ï¼ˆé‡å‘½åï¼‰ï¼š
  ä»ï¼šuploads/test-1704067200000.jpg
  åˆ°ï¼štemp_chunks/test.jpg_512000_.../chunk-0
  
{ overwrite: true }ï¼šå¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œè¦†ç›–å®ƒ
```

**ä¸ºä»€ä¹ˆè¦ç§»åŠ¨ï¼Ÿ**
```
Multer é»˜è®¤ä¿å­˜ä½ç½®ï¼šuploads/
æˆ‘ä»¬éœ€è¦çš„ä½ç½®ï¼štemp_chunks/fileId/chunk-0

æ‰€ä»¥è¦ç§»åŠ¨åˆ°æ­£ç¡®çš„ä½ç½®
```

**åˆ†å—å‘½å**ï¼š
```
chunk-0  â† ç¬¬1å—
chunk-1  â† ç¬¬2å—
chunk-2  â† ç¬¬3å—
...

æŒ‰æ•°å­—é¡ºåºï¼Œæ–¹ä¾¿åé¢åˆå¹¶
```

#### æ­¥éª¤4ï¼šè¿”å›å“åº”

```javascript
    res.json({
      success: true,
      message: `åˆ†å— ${chunkNumber} ä¸Šä¼ æˆåŠŸ`
    })
  } catch (error) {
    console.error(`åˆ†å—ä¸Šä¼ å¤±è´¥: ${error.message}`)
    res.status(500).json({
      success: false,
      message: 'åˆ†å—ä¸Šä¼ å¤±è´¥',
      error: error.message
    })
  }
})
```

**å‰åç«¯äº¤äº’**ï¼š
```
å‰ç«¯å‘é€ï¼š
POST /upload-chunk
FormData:
  - chunk: Blob (1MB æ•°æ®)
  - filename: "test.jpg"
  - fileId: "test.jpg_512000_..."
  - chunkNumber: 0
  - totalChunks: 5

åç«¯å¤„ç†ï¼š
1. æ¥æ”¶æ–‡ä»¶ â†’ req.file
2. åˆ›å»ºç›®å½• â†’ temp_chunks/test.jpg_512000_.../
3. ä¿å­˜åˆ†å— â†’ chunk-0
4. è¿”å›å“åº”

åç«¯è¿”å›ï¼š
{
  success: true,
  message: "åˆ†å— 0 ä¸Šä¼ æˆåŠŸ"
}
```

---

### æ¥å£2: POST /merge-chunks - åˆå¹¶åˆ†å—

```javascript
app.post('/merge-chunks', async (req, res) => {
```

**ä¸ºä»€ä¹ˆç”¨ asyncï¼Ÿ**
```
åˆå¹¶æ–‡ä»¶æ˜¯å¼‚æ­¥æ“ä½œï¼ˆI/Oå¯†é›†ï¼‰ï¼š
- è¯»å–åˆ†å—æ–‡ä»¶
- å†™å…¥æœ€ç»ˆæ–‡ä»¶
- åˆ é™¤ä¸´æ—¶æ–‡ä»¶

ä½¿ç”¨ async/await è®©ä»£ç æ›´æ¸…æ™°
```

#### æ­¥éª¤1ï¼šè·å–å‚æ•°å¹¶è¿›è¡Œå®Œæ•´æ€§éªŒè¯

```javascript
  try {
    const { filename, fileId, totalChunks } = req.body
    const chunkDir = path.resolve(temp_dir, fileId)
    const completedFlag = path.resolve(completed_dir, fileId)
    
    console.log(`å¼€å§‹åˆå¹¶: ${filename} (å…± ${totalChunks} å—)`)
    console.log(`åˆ†å—ç›®å½•: ${chunkDir}`)
    console.log(`å®Œæˆæ ‡è®°: ${completedFlag}`)
    
    // ğŸ¯ ä¼˜å…ˆæ£€æŸ¥ï¼šè¯¥æ–‡ä»¶æ˜¯å¦å·²ç»å®Œæˆè¿‡ï¼ˆé¿å…é‡å¤ä¸Šä¼ ï¼‰
    if (fs.existsSync(completedFlag)) {
      try {
        const savedFilename = await fs.readFile(completedFlag, 'utf-8')
        const actualFilePath = path.resolve(upload_dir, savedFilename)
        
        // ğŸ” å…³é”®æ£€æŸ¥ï¼šéªŒè¯å®é™…æ–‡ä»¶æ˜¯å¦çœŸå®å­˜åœ¨
        if (fs.existsSync(actualFilePath)) {
          console.log(`âœ“ æ–‡ä»¶ ${filename} å·²å­˜åœ¨ï¼Œè·³è¿‡é‡å¤ä¸Šä¼ `)
          console.log(`  å®é™…æ–‡ä»¶: ${savedFilename}`)
          return res.json({
            success: true,
            message: 'æ–‡ä»¶å·²ä¸Šä¼ ï¼ˆè·³è¿‡é‡å¤ï¼‰',
            filename: savedFilename
          })
        } else {
          // âš ï¸ æ ‡è®°æ–‡ä»¶å­˜åœ¨ï¼Œä½†å®é™…æ–‡ä»¶ä¸å­˜åœ¨ï¼ˆå¯èƒ½è¢«åˆ é™¤ï¼‰
          console.log(`âš ï¸ æ ‡è®°å­˜åœ¨ä½†æ–‡ä»¶ä¸å­˜åœ¨: ${savedFilename}`)
          console.log(`  åˆ é™¤æ— æ•ˆæ ‡è®°ï¼Œé‡æ–°ä¸Šä¼ `)
          await fs.remove(completedFlag)
          // ç»§ç»­æ‰§è¡Œåç»­çš„åˆå¹¶æµç¨‹
        }
      } catch (readError) {
        console.error(`è¯»å–å®Œæˆæ ‡è®°å¤±è´¥: ${readError.message}`)
        // å¦‚æœè¯»å–å¤±è´¥ï¼Œåˆ é™¤æŸåçš„æ ‡è®°æ–‡ä»¶ï¼Œç»§ç»­åˆå¹¶æµç¨‹
        await fs.remove(completedFlag)
      }
    }
    
    // æ£€æŸ¥åˆ†å—ç›®å½•æ˜¯å¦å­˜åœ¨
    if (!fs.existsSync(chunkDir)) {
      console.log(`âŒ åˆ†å—ç›®å½•ä¸å­˜åœ¨: ${fileId}`)
      return res.status(400).json({
        success: false,
        message: 'åˆ†å—ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°ä¸Šä¼ '
      })
    }
```

**å®Œæ•´æ€§éªŒè¯é€»è¾‘è¯¦è§£**ï¼š

```
ç¬¬1æ­¥ï¼šæ£€æŸ¥æ ‡è®°æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  â”œâ”€ ä¸å­˜åœ¨ â†’ ç»§ç»­æ­£å¸¸åˆå¹¶æµç¨‹
  â””â”€ å­˜åœ¨ â†’ è¿›å…¥ç¬¬2æ­¥

ç¬¬2æ­¥ï¼šè¯»å–æ ‡è®°æ–‡ä»¶ï¼ˆè·å–æœ€ç»ˆæ–‡ä»¶åï¼‰
  â”œâ”€ è¯»å–å¤±è´¥ â†’ åˆ é™¤æŸåçš„æ ‡è®° â†’ ç»§ç»­åˆå¹¶
  â””â”€ è¯»å–æˆåŠŸ â†’ è¿›å…¥ç¬¬3æ­¥

ç¬¬3æ­¥ï¼šéªŒè¯å®é™…æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  â”œâ”€ æ–‡ä»¶å­˜åœ¨ â†’ è¿”å›æˆåŠŸï¼ˆè·³è¿‡ä¸Šä¼ ï¼‰âœ“
  â””â”€ æ–‡ä»¶ä¸å­˜åœ¨ â†’ åˆ é™¤æ— æ•ˆæ ‡è®° â†’ é‡æ–°åˆå¹¶ â™»ï¸
```

**ä¸ºä»€ä¹ˆéœ€è¦åŒé‡éªŒè¯ï¼Ÿ**
```
åœºæ™¯ï¼š
1. æ–‡ä»¶ä¸Šä¼ å®Œæˆ â†’ åˆ›å»ºæ ‡è®°
2. æœ‰äººæ‰‹åŠ¨åˆ é™¤ uploads/test.jpg
3. å†æ¬¡ä¸Šä¼ åŒä¸€æ–‡ä»¶

å¦‚æœåªæ£€æŸ¥æ ‡è®°ï¼š
  âŒ æ£€æµ‹åˆ°æ ‡è®° â†’ ç›´æ¥è¿”å›æˆåŠŸ
  âŒ ä½†å®é™…æ–‡ä»¶ä¸å­˜åœ¨ï¼

åŒé‡éªŒè¯ï¼š
  âœ“ æ£€æµ‹åˆ°æ ‡è®° â†’ éªŒè¯å®é™…æ–‡ä»¶
  âœ“ æ–‡ä»¶ä¸å­˜åœ¨ â†’ åˆ é™¤æ ‡è®° â†’ é‡æ–°ä¸Šä¼ 
  âœ“ ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
```

**fs.existsSync() æ˜¯ä»€ä¹ˆï¼Ÿ**
```javascript
// åŒæ­¥æ£€æŸ¥æ–‡ä»¶/ç›®å½•æ˜¯å¦å­˜åœ¨
if (fs.existsSync(path)) {
  console.log('å­˜åœ¨')
} else {
  console.log('ä¸å­˜åœ¨')
}
```

#### æ­¥éª¤2ï¼šç”Ÿæˆæœ€ç»ˆæ–‡ä»¶å

```javascript
    // ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶å
    const ext = path.extname(filename)              // è·å–æ‰©å±•å
    const basename = path.basename(filename, ext)   // è·å–æ–‡ä»¶å
    const finalFileName = `${basename}-${Date.now()}${ext}`
    const finalFilePath = path.resolve(upload_dir, finalFileName)
```

**ç¤ºä¾‹**ï¼š
```javascript
filename = "test.jpg"

ext = path.extname("test.jpg")
// ext = ".jpg"

basename = path.basename("test.jpg", ".jpg")
// basename = "test"

finalFileName = `test-${Date.now()}.jpg`
// finalFileName = "test-1704067200000.jpg"

finalFilePath = path.resolve(upload_dir, finalFileName)
// finalFilePath = "F:/node_upload/upload_server/uploads/test-1704067200000.jpg"
```

**ä¸ºä»€ä¹ˆè¦åŠ æ—¶é—´æˆ³ï¼Ÿ**
```
ç”¨æˆ·å¯èƒ½å¤šæ¬¡ä¸Šä¼ åŒåæ–‡ä»¶ï¼š
- test.jpg (ç¬¬1æ¬¡)
- test.jpg (ç¬¬2æ¬¡)

ä¸åŠ æ—¶é—´æˆ³ â†’ æ–‡ä»¶ä¼šè¢«è¦†ç›–
åŠ æ—¶é—´æˆ³ â†’ ç”Ÿæˆä¸åŒçš„æ–‡ä»¶å
  - test-1704067200000.jpg
  - test-1704067300000.jpg
```

#### æ­¥éª¤3ï¼šåˆ›å»ºå†™å…¥æµ

```javascript
    // åˆ›å»ºå†™å…¥æµï¼ŒæŒ‰é¡ºåºåˆå¹¶åˆ†å—
    const writeStream = fs.createWriteStream(finalFilePath)
```

**æµï¼ˆStreamï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ**
```
æµå°±åƒæ°´ç®¡ï¼š
- æ•°æ®åƒæ°´ä¸€æ ·æµåŠ¨
- ä¸éœ€è¦ä¸€æ¬¡æ€§è¯»å…¥å†…å­˜
- é€‚åˆå¤„ç†å¤§æ–‡ä»¶

createWriteStream()ï¼šåˆ›å»ºå†™å…¥æµ
  - æ‰“å¼€æ–‡ä»¶
  - å‡†å¤‡å†™å…¥æ•°æ®
```

**ä¸ºä»€ä¹ˆç”¨æµï¼Ÿ**
```
æ–¹å¼1ï¼šä¸€æ¬¡æ€§è¯»å†™ï¼ˆä¸æ¨èï¼‰
  è¯»å–åˆ†å—0 â†’ å…¨éƒ¨å†…å®¹åˆ°å†…å­˜
  è¯»å–åˆ†å—1 â†’ å…¨éƒ¨å†…å®¹åˆ°å†…å­˜
  ...
  åˆå¹¶ â†’ å†…å­˜çˆ†ç‚¸ï¼

æ–¹å¼2ï¼šæµå¼è¯»å†™ï¼ˆæ¨èï¼‰
  è¯»å–åˆ†å—0 â†’ è¾¹è¯»è¾¹å†™
  è¯»å–åˆ†å—1 â†’ è¾¹è¯»è¾¹å†™
  ...
  å†…å­˜å ç”¨å°
```

#### æ­¥éª¤4ï¼šå¾ªç¯åˆå¹¶åˆ†å—

```javascript
    for (let i = 0; i < totalChunks; i++) {
      const chunkPath = path.resolve(chunkDir, `chunk-${i}`)
      
      // æ£€æŸ¥åˆ†å—æ˜¯å¦å­˜åœ¨
      if (!fs.existsSync(chunkPath)) {
        writeStream.close()  // å…³é—­å†™å…¥æµ
        return res.status(400).json({
          success: false,
          message: `åˆ†å— ${i} ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°ä¸Šä¼ `
        })
      }
      
      // è¯»å–å¹¶å†™å…¥åˆ†å—
      const chunkBuffer = await fs.readFile(chunkPath)
      writeStream.write(chunkBuffer)
    }
```

**é€æ­¥è®²è§£**ï¼š

```javascript
// 1. æ„é€ åˆ†å—è·¯å¾„
const chunkPath = path.resolve(chunkDir, `chunk-${i}`)
// â†’ "temp_chunks/test.jpg_512000_.../chunk-0"
```

```javascript
// 2. æ£€æŸ¥åˆ†å—æ˜¯å¦å­˜åœ¨
if (!fs.existsSync(chunkPath)) {
  // åˆ†å—ä¸¢å¤±ï¼Œåœæ­¢åˆå¹¶ï¼Œè¿”å›é”™è¯¯
  writeStream.close()
  return res.status(400).json({ ... })
}
```

```javascript
// 3. è¯»å–åˆ†å—åˆ°å†…å­˜
const chunkBuffer = await fs.readFile(chunkPath)
// Bufferï¼šäºŒè¿›åˆ¶æ•°æ®
```

**Buffer æ˜¯ä»€ä¹ˆï¼Ÿ**
```
Buffer å°±åƒä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼š
[01010101, 11001100, 10101010, ...]

ç”¨äºå­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ï¼ˆå›¾ç‰‡ã€è§†é¢‘ç­‰ï¼‰
```

```javascript
// 4. å†™å…¥åˆ°æœ€ç»ˆæ–‡ä»¶
writeStream.write(chunkBuffer)
// è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾
```

**åˆå¹¶è¿‡ç¨‹**ï¼š
```
æœ€ç»ˆæ–‡ä»¶ï¼štest-xxx.jpg
  
å†™å…¥ chunk-0ï¼š
  [åˆ†å—0çš„æ•°æ®]

å†™å…¥ chunk-1ï¼š
  [åˆ†å—0çš„æ•°æ®][åˆ†å—1çš„æ•°æ®]

å†™å…¥ chunk-2ï¼š
  [åˆ†å—0çš„æ•°æ®][åˆ†å—1çš„æ•°æ®][åˆ†å—2çš„æ•°æ®]

...

å®Œæˆï¼šå®Œæ•´çš„æ–‡ä»¶
```

#### æ­¥éª¤5ï¼šç­‰å¾…å†™å…¥å®Œæˆ

```javascript
    writeStream.end()  // å…³é—­å†™å…¥æµ
    
    // ç­‰å¾…å†™å…¥å®Œæˆ
    await new Promise((resolve, reject) => {
      writeStream.on('finish', resolve)
      writeStream.on('error', reject)
    })
```

**writeStream.end() æ˜¯ä»€ä¹ˆï¼Ÿ**
```
å‘Šè¯‰æµï¼š"æˆ‘å†™å®Œäº†ï¼Œå¯ä»¥å…³é—­äº†"
- æ¸…ç©ºç¼“å†²åŒº
- å…³é—­æ–‡ä»¶
- è§¦å‘ 'finish' äº‹ä»¶
```

**ä¸ºä»€ä¹ˆè¦ç­‰å¾…ï¼Ÿ**
```
writeStream.write() æ˜¯å¼‚æ­¥çš„ï¼š
- è°ƒç”¨åç«‹å³è¿”å›
- å®é™…å†™å…¥åœ¨åå°è¿›è¡Œ
- å¯èƒ½è¿˜æ²¡å†™å®Œ

await Promiseï¼š
- ç­‰å¾… 'finish' äº‹ä»¶
- ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½å†™å…¥ç£ç›˜
- ç„¶åç»§ç»­æ‰§è¡Œ
```

**Promise ç›‘å¬äº‹ä»¶**ï¼š
```javascript
new Promise((resolve, reject) => {
  writeStream.on('finish', resolve)  // æˆåŠŸæ—¶è°ƒç”¨
  writeStream.on('error', reject)    // å¤±è´¥æ—¶è°ƒç”¨
})

// 'finish'ï¼šå†™å…¥å®Œæˆ
// 'error'ï¼šå†™å…¥å‡ºé”™
```

#### æ­¥éª¤6ï¼šåˆ é™¤ä¸´æ—¶æ–‡ä»¶å¹¶åˆ›å»ºå®Œæˆæ ‡è®°

```javascript
    // åˆ é™¤ä¸´æ—¶åˆ†å—ç›®å½•
    await fs.remove(chunkDir)
    
    // ğŸ¯ åˆ›å»ºå®Œæˆæ ‡è®°ï¼ˆä¿å­˜æœ€ç»ˆæ–‡ä»¶åï¼Œé¿å…é‡å¤ä¸Šä¼ ï¼‰
    try {
      // ç¡®ä¿ .completed ç›®å½•å­˜åœ¨
      await fs.ensureDir(completed_dir)
      await fs.writeFile(completedFlag, finalFileName, 'utf-8')
      console.log(`âœ“ åˆ›å»ºå®Œæˆæ ‡è®°: ${fileId}`)
    } catch (flagError) {
      // æ ‡è®°åˆ›å»ºå¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼Œä»…è®°å½•æ—¥å¿—
      console.error(`âš ï¸ åˆ›å»ºå®Œæˆæ ‡è®°å¤±è´¥: ${flagError.message}`)
    }
    
    console.log(`åˆå¹¶æˆåŠŸ: ${finalFileName}`)
```

**fs.remove() æ˜¯ä»€ä¹ˆï¼Ÿ**
```
åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•ï¼ˆåŒ…æ‹¬é‡Œé¢çš„æ‰€æœ‰å†…å®¹ï¼‰ï¼š
  temp_chunks/test.jpg_512000_.../
    â”œâ”€â”€ chunk-0
    â”œâ”€â”€ chunk-1
    â””â”€â”€ chunk-2
  
  å…¨éƒ¨åˆ é™¤
```

**ä¸ºä»€ä¹ˆè¦åˆ é™¤ï¼Ÿ**
```
ä¸´æ—¶åˆ†å—å·²ç»åˆå¹¶æˆæœ€ç»ˆæ–‡ä»¶ï¼š
- ä¸å†éœ€è¦
- å ç”¨ç£ç›˜ç©ºé—´
- åŠæ—¶æ¸…ç†
```

**åˆ›å»ºå®Œæˆæ ‡è®°çš„ä½œç”¨**ï¼š
```
æ ‡è®°æ–‡ä»¶ï¼šupload_completed/test.jpg_512000_...
æ ‡è®°å†…å®¹ï¼š"test-1704067200000.jpg"

ä½œç”¨ï¼š
1. è®°å½•æ–‡ä»¶å·²å®Œæˆä¸Šä¼ 
2. ä¸‹æ¬¡ä¸Šä¼ åŒä¸€æ–‡ä»¶æ—¶ï¼Œæ£€æŸ¥æ ‡è®°
3. å¦‚æœæ ‡è®°å­˜åœ¨ä¸”æ–‡ä»¶å­˜åœ¨ â†’ è·³è¿‡ä¸Šä¼ 
4. å¦‚æœæ ‡è®°å­˜åœ¨ä½†æ–‡ä»¶ä¸å­˜åœ¨ â†’ åˆ é™¤æ ‡è®°ï¼Œé‡æ–°ä¸Šä¼ 

ä¼˜ç‚¹ï¼š
- é¿å…é‡å¤ä¸Šä¼ 
- èŠ‚çœå¸¦å®½å’Œæ—¶é—´
- æå‡ç”¨æˆ·ä½“éªŒ
```

**ä¸ºä»€ä¹ˆè¦ try-catchï¼Ÿ**
```
æ ‡è®°åˆ›å»ºå¤±è´¥çš„åŸå› ï¼š
- ç›®å½•ä¸å­˜åœ¨
- ç£ç›˜ç©ºé—´ä¸è¶³
- æƒé™é—®é¢˜

å¤„ç†ç­–ç•¥ï¼š
- æ ‡è®°å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
- æ–‡ä»¶å·²ç»æˆåŠŸåˆå¹¶
- ä»…è®°å½•è­¦å‘Šæ—¥å¿—
- ä¸‹æ¬¡ä¸Šä¼ æ—¶ä¼šé‡æ–°åˆ›å»ºæ ‡è®°
```

#### æ­¥éª¤7ï¼šè¿”å›å“åº”

```javascript
    res.json({
      success: true,
      message: 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸ',
      filename: finalFileName
    })
  } catch (error) {
    console.error(`æ–‡ä»¶åˆå¹¶å¤±è´¥: ${error.message}`)
    res.status(500).json({
      success: false,
      message: 'æ–‡ä»¶åˆå¹¶å¤±è´¥',
      error: error.message
    })
  }
})
```

**å‰åç«¯äº¤äº’**ï¼š
```
å‰ç«¯å‘é€ï¼š
POST /merge-chunks
Content-Type: application/json
{
  "filename": "test.jpg",
  "fileId": "test.jpg_512000_...",
  "totalChunks": 3
}

åç«¯å¤„ç†ï¼š
1. æ£€æŸ¥å®Œæˆæ ‡è®°ï¼ˆæ˜¯å¦å·²ä¸Šä¼ è¿‡ï¼‰
2. éªŒè¯å®é™…æ–‡ä»¶å­˜åœ¨ï¼ˆåŒé‡éªŒè¯ï¼‰
3. æ£€æŸ¥åˆ†å—ç›®å½•æ˜¯å¦å­˜åœ¨
4. ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶å
5. åˆ›å»ºå†™å…¥æµ
6. å¾ªç¯è¯»å–åˆ†å—å¹¶å†™å…¥
7. ç­‰å¾…å†™å…¥å®Œæˆ
8. åˆ é™¤ä¸´æ—¶åˆ†å—
9. åˆ›å»ºå®Œæˆæ ‡è®°
10. è¿”å›å“åº”

åç«¯è¿”å›ï¼š
{
  "success": true,
  "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ",
  "filename": "test-1704067200000.jpg"
}
```

---

### æ¥å£3: POST /upload - ä¼ ç»Ÿä¸Šä¼ ï¼ˆä¿ç•™ï¼‰

```javascript
app.post('/upload', upload.single('file'), (req, res) => {
  if (!req.file) {
    return res.status(400).json({
      success: false,
      message: 'No file uploaded'
    })
  }
  res.json({
    success: true,
    message: 'File uploaded successfully',
    filePath: req.file.path,
    filename: req.file.filename
  })
})
```

**è¿™æ˜¯ä»€ä¹ˆï¼Ÿ**
```
ä¼ ç»Ÿçš„ä¸€æ¬¡æ€§ä¸Šä¼ æ¥å£ï¼š
- æ•´ä¸ªæ–‡ä»¶ä¸€æ¬¡ä¸Šä¼ 
- ä¸åˆ†å—
- ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ 

ä¿ç•™å®ƒæ˜¯ä¸ºäº†å…¼å®¹æ€§
```

---

### å¯åŠ¨æœåŠ¡å™¨

```javascript
app.listen(3000, () => {
  console.log('Server is running on port 3000')
})
```

**app.listen() æ˜¯ä»€ä¹ˆï¼Ÿ**
```
å¯åŠ¨æœåŠ¡å™¨ï¼Œç›‘å¬ç«¯å£ 3000ï¼š
- è®¿é—® http://localhost:3000
- æ¥æ”¶å‰ç«¯çš„è¯·æ±‚
- è¿”å›å“åº”
```

**ä¸ºä»€ä¹ˆæ˜¯ 3000ï¼Ÿ**
```
å¸¸ç”¨çš„å¼€å‘ç«¯å£ï¼š
- å‰ç«¯ï¼š5173ï¼ˆViteé»˜è®¤ï¼‰
- åç«¯ï¼š3000ï¼ˆExpresså¸¸ç”¨ï¼‰

å¯ä»¥æ”¹æˆå…¶ä»–ç«¯å£ï¼Œä½†è¦ä¿æŒå‰åç«¯ä¸€è‡´
```

---

## å®Œæ•´æµç¨‹å›¾

### åˆ†å—ä¸Šä¼ æµç¨‹

```
å‰ç«¯                                åç«¯
 â”‚                                   â”‚
 â”œâ”€ åˆ‡å‰²æ–‡ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚  [chunk-0, chunk-1, chunk-2]      â”‚
 â”‚                                   â”‚
 â”œâ”€ POST /upload-chunk (chunk-0) â”€â”€>â”‚
 â”‚  FormData:                        â”‚
 â”‚  - chunk: Blob                    â”‚
 â”‚  - filename: "test.jpg"           â”‚
 â”‚  - fileId: "test.jpg_512000_..."  â”‚
 â”‚  - chunkNumber: 0                 â”‚
 â”‚  - totalChunks: 3                 â”‚
 â”‚                                   â”œâ”€ æ¥æ”¶æ–‡ä»¶ (req.file)
 â”‚                                   â”œâ”€ åˆ›å»ºç›®å½•
 â”‚                                   â”‚  temp_chunks/test.jpg_512000_.../
 â”‚                                   â”œâ”€ ä¿å­˜åˆ†å—
 â”‚                                   â”‚  chunk-0
 â”‚<â”€â”€ { success: true } â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                                   â”‚
 â”œâ”€ POST /upload-chunk (chunk-1) â”€â”€>â”‚
 â”‚                                   â”œâ”€ ä¿å­˜åˆ†å—
 â”‚                                   â”‚  chunk-1
 â”‚<â”€â”€ { success: true } â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                                   â”‚
 â”œâ”€ POST /upload-chunk (chunk-2) â”€â”€>â”‚
 â”‚                                   â”œâ”€ ä¿å­˜åˆ†å—
 â”‚                                   â”‚  chunk-2
 â”‚<â”€â”€ { success: true } â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                                   â”‚
 â”œâ”€ POST /merge-chunks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚  { filename, fileId, totalChunks }â”‚
 â”‚                                   â”œâ”€ ğŸ” æ£€æŸ¥å®Œæˆæ ‡è®°
 â”‚                                   â”œâ”€ ğŸ” éªŒè¯æ–‡ä»¶å­˜åœ¨
 â”‚                                   â”œâ”€ æ£€æŸ¥åˆ†å—ç›®å½•
 â”‚                                   â”œâ”€ ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶å
 â”‚                                   â”œâ”€ åˆ›å»ºå†™å…¥æµ
 â”‚                                   â”œâ”€ å¾ªç¯åˆå¹¶åˆ†å—
 â”‚                                   â”‚  writeStream.write(chunk-0)
 â”‚                                   â”‚  writeStream.write(chunk-1)
 â”‚                                   â”‚  writeStream.write(chunk-2)
 â”‚                                   â”œâ”€ ç­‰å¾…å†™å…¥å®Œæˆ
 â”‚                                   â”œâ”€ åˆ é™¤ä¸´æ—¶ç›®å½•
 â”‚                                   â”‚  rm -rf temp_chunks/test.jpg_512000_.../
 â”‚                                   â”œâ”€ ğŸ¯ åˆ›å»ºå®Œæˆæ ‡è®°
 â”‚                                   â”‚  upload_completed/test.jpg_512000_...
 â”‚<â”€â”€ { success: true } â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚    { filename: "test-xxx.jpg" }   â”‚
 â”‚                                   â”‚
 â””â”€ æ˜¾ç¤ºä¸Šä¼ æˆåŠŸ                      â””â”€ æ–‡ä»¶ä¿å­˜å®Œæˆ
                                        uploads/test-xxx.jpg
```

### ç›®å½•å˜åŒ–

```
å¼€å§‹ï¼š
upload_server/
â”œâ”€â”€ uploads/           (ç©º)
â”œâ”€â”€ temp_chunks/       (ç©º)
â””â”€â”€ upload_completed/  (ç©º)

æ”¶åˆ° chunk-0ï¼š
upload_server/
â”œâ”€â”€ uploads/
â”œâ”€â”€ temp_chunks/
â”‚   â””â”€â”€ test.jpg_512000_.../
â”‚       â””â”€â”€ chunk-0
â””â”€â”€ upload_completed/

æ”¶åˆ° chunk-1ï¼š
upload_server/
â”œâ”€â”€ uploads/
â”œâ”€â”€ temp_chunks/
â”‚   â””â”€â”€ test.jpg_512000_.../
â”‚       â”œâ”€â”€ chunk-0
â”‚       â””â”€â”€ chunk-1
â””â”€â”€ upload_completed/

æ”¶åˆ° chunk-2ï¼š
upload_server/
â”œâ”€â”€ uploads/
â”œâ”€â”€ temp_chunks/
â”‚   â””â”€â”€ test.jpg_512000_.../
â”‚       â”œâ”€â”€ chunk-0
â”‚       â”œâ”€â”€ chunk-1
â”‚       â””â”€â”€ chunk-2
â””â”€â”€ upload_completed/

åˆå¹¶å®Œæˆï¼š
upload_server/
â”œâ”€â”€ uploads/
â”‚   â””â”€â”€ test-1704067200000.jpg  â† æœ€ç»ˆæ–‡ä»¶
â”œâ”€â”€ temp_chunks/                â† ä¸´æ—¶ç›®å½•è¢«åˆ é™¤
â””â”€â”€ upload_completed/             â† ğŸ¯ å®Œæˆæ ‡è®°
    â””â”€â”€ test.jpg_512000_...     (å†…å®¹: "test-1704067200000.jpg")
```

---

## å‰åç«¯äº¤äº’

### æ•°æ®æ ¼å¼

#### ä¸Šä¼ åˆ†å—

**å‰ç«¯å‘é€**ï¼š
```
POST http://localhost:3000/upload-chunk
Content-Type: multipart/form-data

FormData:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ chunk: Blob (binary data)      â”‚
â”‚ filename: "test.jpg"           â”‚
â”‚ fileId: "test.jpg_512000_..."  â”‚
â”‚ chunkNumber: 0                 â”‚
â”‚ totalChunks: 3                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åç«¯æ¥æ”¶**ï¼š
```javascript
req.body = {
  filename: "test.jpg",
  fileId: "test.jpg_512000_...",
  chunkNumber: "0",        // æ³¨æ„ï¼šå­—ç¬¦ä¸²ç±»å‹
  totalChunks: "3"
}

req.file = {
  fieldname: 'chunk',
  originalname: 'blob',
  filename: 'xxx.jpg',
  path: 'F:/node_upload/upload_server/uploads/xxx.jpg',
  size: 1048576
}
```

**åç«¯è¿”å›**ï¼š
```json
{
  "success": true,
  "message": "åˆ†å— 0 ä¸Šä¼ æˆåŠŸ"
}
```

#### åˆå¹¶æ–‡ä»¶

**å‰ç«¯å‘é€**ï¼š
```
POST http://localhost:3000/merge-chunks
Content-Type: application/json

{
  "filename": "test.jpg",
  "fileId": "test.jpg_512000_...",
  "totalChunks": 3
}
```

**åç«¯æ¥æ”¶**ï¼š
```javascript
req.body = {
  filename: "test.jpg",
  fileId: "test.jpg_512000_...",
  totalChunks: 3          // æ³¨æ„ï¼šæ•°å­—ç±»å‹
}
```

**åç«¯è¿”å›ï¼ˆæˆåŠŸï¼‰**ï¼š
```json
{
  "success": true,
  "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ",
  "filename": "test-1704067200000.jpg"
}
```

**åç«¯è¿”å›ï¼ˆè·³è¿‡é‡å¤ï¼‰**ï¼š
```json
{
  "success": true,
  "message": "æ–‡ä»¶å·²ä¸Šä¼ ï¼ˆè·³è¿‡é‡å¤ï¼‰",
  "filename": "test-1704067200000.jpg"
}
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆç”¨ Multerï¼Ÿ
**A**: Express æœ¬èº«ä¸å¤„ç†æ–‡ä»¶ä¸Šä¼ ã€‚Multer ä¸“é—¨å¤„ç† multipart/form-dataï¼Œè‡ªåŠ¨ä¿å­˜æ–‡ä»¶å¹¶æä¾›æ–‡ä»¶ä¿¡æ¯ã€‚

### Q2: ä¸ºä»€ä¹ˆç”¨æµï¼Ÿ
**A**: å†…å­˜æ•ˆç‡é«˜ï¼Œæ”¯æŒå¤§æ–‡ä»¶ï¼Œè¾¹è¯»è¾¹å†™ï¼Œä¸å ç”¨è¿‡å¤šå†…å­˜ã€‚

### Q3: ä¸ºä»€ä¹ˆç”¨æ—¶é—´æˆ³å‘½åï¼Ÿ
**A**: é¿å…æ–‡ä»¶åå†²çªï¼Œä¿ç•™æ‰€æœ‰ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæ˜“äºç®¡ç†å’ŒæŸ¥æ‰¾ã€‚

### Q4: ä¸ºä»€ä¹ˆè¦åˆ†å—ï¼Ÿ
**A**: æ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ ï¼Œç½‘ç»œä¸­æ–­å¯ä»¥ç»­ä¼ ï¼Œæé«˜ä¸Šä¼ æˆåŠŸç‡ã€‚

### Q5: ä¸ºä»€ä¹ˆç”¨ fileIdï¼Ÿ
**A**: åŒºåˆ†ä¸åŒæ–‡ä»¶ï¼ŒåŒä¸€æ–‡ä»¶çš„åˆ†å—æ”¾åœ¨åŒä¸€ç›®å½•ï¼Œæ”¯æŒå¹¶å‘ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ã€‚

### Q6: ä¸ºä»€ä¹ˆéœ€è¦å®Œæˆæ ‡è®°ï¼Ÿ
**A**: é¿å…é‡å¤ä¸Šä¼ ç›¸åŒæ–‡ä»¶ï¼ŒèŠ‚çœå¸¦å®½å’Œæ—¶é—´ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

### Q7: ä¸ºä»€ä¹ˆéœ€è¦åŒé‡éªŒè¯ï¼Ÿ
**A**: æ ‡è®°æ–‡ä»¶å­˜åœ¨ä¸ä»£è¡¨å®é™…æ–‡ä»¶å­˜åœ¨ã€‚åŒé‡éªŒè¯ç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼Œè‡ªåŠ¨ä¿®å¤ä¸ä¸€è‡´çŠ¶æ€ã€‚

### Q8: ä¸´æ—¶æ–‡ä»¶ä¼šä¸€ç›´å †ç§¯å—ï¼Ÿ
**A**: ä¸ä¼šã€‚åˆå¹¶æˆåŠŸåä¼šè‡ªåŠ¨åˆ é™¤ä¸´æ—¶åˆ†å—ç›®å½•ã€‚å¯ä»¥æ·»åŠ å®šæ—¶ä»»åŠ¡æ¸…ç†é•¿æ—¶é—´æœªåˆå¹¶çš„ä¸´æ—¶æ–‡ä»¶ã€‚

---

## è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

```bash
# å¯åŠ¨æœåŠ¡å™¨
node app.js

# çœ‹åˆ°è¾“å‡ºï¼š
Server is running on port 3000
å®Œæˆæ ‡è®°ç›®å½•: F:/node_upload/upload_server/upload_completed
å·²æ¥æ”¶: test.jpg åˆ†å— 0/3
å·²æ¥æ”¶: test.jpg åˆ†å— 1/3
å·²æ¥æ”¶: test.jpg åˆ†å— 2/3
å¼€å§‹åˆå¹¶: test.jpg (å…± 3 å—)
åˆ†å—ç›®å½•: F:/node_upload/upload_server/temp_chunks/test.jpg_512000_...
å®Œæˆæ ‡è®°: F:/node_upload/upload_server/upload_completed/test.jpg_512000_...
âœ“ åˆ›å»ºå®Œæˆæ ‡è®°: test.jpg_512000_...
åˆå¹¶æˆåŠŸ: test-1704067200000.jpg
```

### æŸ¥çœ‹ç›®å½•ç»“æ„

```bash
# ä¸Šä¼ è¿‡ç¨‹ä¸­
ls temp_chunks/test.jpg_512000_.../
# chunk-0  chunk-1  chunk-2

# ä¸Šä¼ å®Œæˆå
ls uploads/
# test-1704067200000.jpg

ls temp_chunks/
# (ç©ºï¼Œå·²åˆ é™¤)

ls upload_completed/
# test.jpg_512000_...
```

### æŸ¥çœ‹å®Œæˆæ ‡è®°å†…å®¹

```bash
# æŸ¥çœ‹æ ‡è®°æ–‡ä»¶å†…å®¹
cat upload_completed/test.jpg_512000_...
# test-1704067200000.jpg
```

---

## ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ å®šæ—¶æ¸…ç†

```javascript
// æ¯å°æ—¶æ¸…ç†è¶…è¿‡24å°æ—¶çš„ä¸´æ—¶æ–‡ä»¶
setInterval(() => {
  const dirs = fs.readdirSync(temp_dir)
  const now = Date.now()
  
  dirs.forEach(dir => {
    const dirPath = path.join(temp_dir, dir)
    const stat = fs.statSync(dirPath)
    const age = now - stat.mtimeMs
    
    // è¶…è¿‡24å°æ—¶ï¼Œåˆ é™¤
    if (age > 24 * 60 * 60 * 1000) {
      fs.removeSync(dirPath)
      console.log(`æ¸…ç†è¿‡æœŸåˆ†å—: ${dir}`)
    }
  })
}, 60 * 60 * 1000)  // æ¯å°æ—¶æ‰§è¡Œ
```

### 2. æ·»åŠ æ–‡ä»¶å¤§å°é™åˆ¶

```javascript
const upload = multer({ 
  storage: storage,
  limits: {
    fileSize: 100 * 1024 * 1024  // é™åˆ¶100MB
  }
})
```

### 3. æ·»åŠ æ–‡ä»¶ç±»å‹æ£€æŸ¥

```javascript
const upload = multer({ 
  storage: storage,
  fileFilter: (req, file, cb) => {
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif']
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true)
    } else {
      cb(new Error('åªå…è®¸ä¸Šä¼ å›¾ç‰‡'))
    }
  }
})
```

---

## æ€»ç»“

åç«¯å®ç°äº†ï¼š

1. âœ… **åˆ†å—æ¥æ”¶**ï¼šç‹¬ç«‹ç›®å½•éš”ç¦»
2. âœ… **åˆ†å—åˆå¹¶**ï¼šæµå¼å¤„ç†ï¼Œå†…å­˜å‹å¥½
3. âœ… **æ–‡ä»¶å­˜å‚¨**ï¼šæ—¶é—´æˆ³å‘½åï¼Œé¿å…å†²çª
4. âœ… **ä¸´æ—¶æ¸…ç†**ï¼šè‡ªåŠ¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶
5. âœ… **é‡å¤æ£€æµ‹**ï¼šå®Œæˆæ ‡è®°æœºåˆ¶
6. âœ… **å®Œæ•´æ€§éªŒè¯**ï¼šåŒé‡éªŒè¯ç¡®ä¿æ•°æ®å¯é 
7. âœ… **é”™è¯¯å¤„ç†**ï¼šå¤šå±‚å¼‚å¸¸æ•è·
8. âœ… **å¥å£®æ€§**ï¼šå®¹é”™å¤„ç†å®Œå–„

ä»£ç ç»“æ„æ¸…æ™°ï¼ŒæŒ‰ä¸šåŠ¡æµç¨‹ç»„ç»‡ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤ã€‚ğŸ‰
