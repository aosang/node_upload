# 断点续传测试指南

## 🎯 什么是断点续传？

上传到一半时，如果网络断开或页面刷新，重新上传时可以**从断点继续**，不需要从头开始。

## 📋 测试步骤

### 方法 1: 页面刷新测试（推荐）

#### 1. 准备测试文件
```
需要一个大于 2MB 的图片文件
- 如果文件太小（<2MB），会被压缩成一个分块，看不出断点续传效果
- 建议使用 5MB-10MB 的图片
```

#### 2. 开始上传
1. 打开浏览器，访问 http://localhost:5173
2. 按 F12 打开开发者工具
3. 切换到 **Console（控制台）** 标签
4. 选择一个 5MB 以上的图片文件
5. 点击"开始上传"

#### 3. 观察上传进度
```
控制台会输出：
[large.jpg] 大文件，不压缩
[large.jpg] 开始上传
[large.jpg] 文件ID: large.jpg_5242880_1704067200000
[large.jpg] 总共 5 块，每块 1MB
[large.jpg] 无断点记录，从头开始
[large.jpg] 分块 1/5 上传成功
[large.jpg] 分块 2/5 上传成功
[large.jpg] 分块 3/5 上传成功  ← 到这里时，准备刷新
```

#### 4. 中断上传
**当看到上传到 50-60% 时**（比如 3/5 块），**立即按 F5 刷新页面**

#### 5. 继续上传
1. 页面刷新后，重新选择**完全相同**的文件（同一个文件）
2. 再次点击"开始上传"
3. **观察控制台输出**

#### 6. 验证断点续传
**预期输出**：
```
[large.jpg] 开始上传
[large.jpg] 文件ID: large.jpg_5242880_1704067200000  ← 相同的ID
[large.jpg] 总共 5 块，每块 1MB
[large.jpg] 发现断点，已上传 3 块  ← ★ 关键！发现断点
[large.jpg] 分块 0 已上传，跳过  ← 跳过
[large.jpg] 分块 1 已上传，跳过  ← 跳过
[large.jpg] 分块 2 已上传，跳过  ← 跳过
[large.jpg] 分块 4/5 上传成功  ← 从这里继续
[large.jpg] 分块 5/5 上传成功
[large.jpg] 开始合并...
[large.jpg] ✓ 上传完成
```

✅ **成功标志**：
- 看到"发现断点，已上传 X 块"
- 看到"分块 X 已上传，跳过"
- 没有重新上传前 3 块
- 直接从第 4 块开始上传

---

### 方法 2: 关闭浏览器测试

#### 1-3. 前面步骤相同

#### 4. 中断上传
**当上传到 50% 时**，**直接关闭浏览器**（不是关闭标签页）

#### 5. 重新打开
1. 重新打开浏览器
2. 访问 http://localhost:5173
3. 按 F12 打开控制台
4. 选择**同一个文件**
5. 点击"开始上传"

#### 6. 验证
应该看到"发现断点，已上传 X 块"，从断点继续

---

### 方法 3: 模拟网络断开（高级）

#### 1-2. 前面步骤相同

#### 3. 模拟断网
1. 开始上传
2. 打开开发者工具 → **Network（网络）** 标签
3. 上传到 30-40% 时
4. 点击顶部的 **Offline（离线）** 选项

#### 4. 观察错误
```
控制台会显示：
[large.jpg] 分块 2 上传失败，重试 1/3
[large.jpg] 分块 2 上传失败，重试 2/3
[large.jpg] 分块 2 上传失败，重试 3/3
[large.jpg] ✗ 上传失败: 分块 2 上传失败
```

#### 5. 恢复网络
1. 取消 **Offline** 选项
2. 重新选择同一个文件
3. 再次上传

#### 6. 验证
应该从断点继续，跳过已上传的分块

---

## 🔍 如何查看断点记录？

### 方法 1: 查看 localStorage

1. 按 F12 打开开发者工具
2. 切换到 **Application（应用）** 标签
3. 左侧找到 **Storage → Local Storage → http://localhost:5173**
4. 查看右侧的键值对

**应该看到**：
```
键: upload_large.jpg_5242880_1704067200000
值: {"chunks":[0,1,2]}
```

**解释**：
- `chunks: [0,1,2]` 表示已经上传了第 0、1、2 块
- 下次上传会从第 3 块开始

### 方法 2: 查看服务端临时文件

打开文件管理器，进入：
```
F:\node_upload\upload_server\temp_chunks\
```

**应该看到**：
```
temp_chunks/
└── large.jpg_5242880_1704067200000/
    ├── chunk-0  ← 已上传
    ├── chunk-1  ← 已上传
    └── chunk-2  ← 已上传
```

这些就是已经上传到服务器的分块。

---

## 🧪 完整测试案例

### 测试用例 1: 小文件（看不到断点续传）

**文件**：500KB 图片

**结果**：
```
[test.jpg] 开始压缩...
[test.jpg] 压缩完成: 512000 -> 102400 字节
[test.jpg] 总共 1 块，每块 1MB  ← 只有1块
[test.jpg] 分块 1/1 上传成功
[test.jpg] ✓ 上传完成
```

**说明**：文件太小，压缩后不到 1MB，只有 1 个分块，看不出断点续传效果。

---

### 测试用例 2: 中等文件（能看到断点续传）

**文件**：5MB 图片

**第一次上传（中断）**：
```
[large.jpg] 大文件，不压缩
[large.jpg] 总共 5 块，每块 1MB
[large.jpg] 分块 1/5 上传成功
[large.jpg] 分块 2/5 上传成功
[large.jpg] 分块 3/5 上传成功
（刷新页面）
```

**第二次上传（续传）**：
```
[large.jpg] 发现断点，已上传 3 块  ← ★ 关键
[large.jpg] 分块 0 已上传，跳过
[large.jpg] 分块 1 已上传，跳过
[large.jpg] 分块 2 已上传，跳过
[large.jpg] 分块 4/5 上传成功
[large.jpg] 分块 5/5 上传成功
[large.jpg] ✓ 上传完成
```

✅ **断点续传成功！**

---

### 测试用例 3: 大文件（更明显）

**文件**：20MB 图片

**第一次上传（中断）**：
```
[huge.jpg] 总共 20 块，每块 1MB
[huge.jpg] 分块 1/20 上传成功
[huge.jpg] 分块 2/20 上传成功
...
[huge.jpg] 分块 10/20 上传成功
（刷新页面）
```

**第二次上传（续传）**：
```
[huge.jpg] 发现断点，已上传 10 块
[huge.jpg] 分块 0-9 已上传，跳过  ← 跳过前10块
[huge.jpg] 分块 11/20 上传成功  ← 从第11块继续
...
[huge.jpg] 分块 20/20 上传成功
[huge.jpg] ✓ 上传完成
```

**好处**：节省了 10MB 的重复上传！

---

## ❓ 常见问题

### Q1: 为什么没有看到"发现断点"？

**可能原因**：
1. **文件不是同一个**
   - 解决：确保选择完全相同的文件，不要复制后再选
   
2. **localStorage 被清理了**
   - 解决：不要手动清理 localStorage
   
3. **文件被修改了**
   - 解决：不要编辑文件，直接选择原文件

4. **浏览器隐私模式**
   - 解决：使用普通模式，不要用隐私/无痕模式

### Q2: 断点续传后，文件是否完整？

**是的**，文件是完整的：
- 服务器会检查所有分块是否都存在
- 按顺序合并所有分块
- 最终文件与原文件完全一致

### Q3: 可以跨设备断点续传吗？

**不可以**，因为：
- 进度保存在浏览器的 localStorage
- localStorage 不能跨设备同步
- 服务器的临时分块可能被清理

如果需要跨设备续传，需要将进度保存到服务器。

### Q4: 断点记录会自动清理吗？

**会的**，在以下情况下：
1. 文件上传成功后，自动清理 localStorage
2. 服务器合并完成后，删除临时分块目录

### Q5: 如果选错文件怎么办？

**没关系**：
- 不同的文件有不同的 fileId
- 不会互相干扰
- 可以同时保存多个文件的断点

---

## 🎓 理解断点续传原理

### 简单比喻

**传统上传**（没有断点续传）：
```
你要搬100块砖到楼上
搬到50块时累了，休息一下
醒来后：需要从头开始搬100块砖  ← 之前的白搬了
```

**断点续传**：
```
你要搬100块砖到楼上
搬到50块时累了，做个标记
醒来后：看到标记，从第51块开始搬  ← 节省时间
```

### 技术原理

```javascript
// 1. 上传时记录进度
localStorage.setItem('upload_xxx', JSON.stringify({
  chunks: [0, 1, 2]  // 已上传的分块
}))

// 2. 重新上传时读取进度
const saved = localStorage.getItem('upload_xxx')
const uploadedChunks = JSON.parse(saved).chunks  // [0, 1, 2]

// 3. 跳过已上传的分块
for (let i = 0; i < totalChunks; i++) {
  if (uploadedChunks.includes(i)) {
    console.log(`分块 ${i} 已上传，跳过`)
    continue  // 跳过
  }
  
  // 上传新的分块
  uploadChunk(i)
}
```

---

## ✅ 测试清单

- [ ] 准备 5MB 以上的图片文件
- [ ] 上传到 50% 时按 F5 刷新
- [ ] 重新选择同一个文件
- [ ] 看到"发现断点，已上传 X 块"
- [ ] 看到"分块 X 已上传，跳过"
- [ ] 从断点继续上传
- [ ] 最终上传成功
- [ ] 检查 localStorage 中的进度记录
- [ ] 检查服务器 temp_chunks 目录

全部打勾 = 断点续传功能正常！🎉

---

## 💡 提示

1. **文件越大，效果越明显**
   - 5MB 文件：节省 2-3 块
   - 20MB 文件：节省 10 块
   - 100MB 文件：节省 50 块

2. **进度会一直保存**
   - 即使关闭浏览器
   - 只要不清理 localStorage
   - 下次打开还能继续

3. **相同文件才能续传**
   - 文件名相同
   - 文件大小相同
   - 文件修改时间相同

4. **调试技巧**
   - 看控制台输出
   - 看 localStorage
   - 看 temp_chunks 目录

祝测试顺利！🚀

